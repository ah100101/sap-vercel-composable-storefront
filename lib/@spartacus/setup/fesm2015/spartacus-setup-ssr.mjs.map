{"version":3,"file":"spartacus-setup-ssr.mjs","sources":["../../../core-libs/setup/ssr/express-utils/express-request-origin.ts","../../../core-libs/setup/ssr/express-utils/express-request-url.ts","../../../core-libs/setup/ssr/optimized-engine/rendering-cache.ts","../../../core-libs/setup/ssr/optimized-engine/ssr-optimization-options.ts","../../../core-libs/setup/ssr/optimized-engine/optimized-ssr-engine.ts","../../../core-libs/setup/ssr/providers/server-request-origin.ts","../../../core-libs/setup/ssr/providers/server-request-url.ts","../../../core-libs/setup/ssr/providers/ssr-providers.ts","../../../core-libs/setup/ssr/engine-decorator/ng-express-engine-decorator.ts","../../../core-libs/setup/ssr/engine-decorator/index.ts","../../../core-libs/setup/ssr/optimized-engine/index.ts","../../../core-libs/setup/ssr/providers/index.ts","../../../core-libs/setup/ssr/public_api.ts","../../../core-libs/setup/ssr/spartacus-setup-ssr.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Request } from 'express';\n\nexport function getRequestOrigin(req: Request): string {\n  // If express is resolving and trusting X-Forwarded-Host, we want to take it\n  // into an account to properly generate request origin.\n  const trustProxyFn = req.app.get('trust proxy fn');\n  let forwardedHost = req.get('X-Forwarded-Host');\n  if (forwardedHost && trustProxyFn(req.connection.remoteAddress, 0)) {\n    if (forwardedHost.indexOf(',') !== -1) {\n      // Note: X-Forwarded-Host is normally only ever a\n      //       single value, but this is to be safe.\n      forwardedHost = forwardedHost\n        .substring(0, forwardedHost.indexOf(','))\n        .trimRight();\n    }\n    return `${req.protocol}://${forwardedHost}`;\n  } else {\n    return `${req.protocol}://${req.get('host')}`;\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Request } from 'express';\nimport { getRequestOrigin } from './express-request-origin';\n\nexport function getRequestUrl(req: Request): string {\n  return getRequestOrigin(req) + req.originalUrl;\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { SsrOptimizationOptions } from './ssr-optimization-options';\n\nexport interface RenderingEntry {\n  html?: any;\n  err?: any;\n  time?: number;\n  rendering?: boolean;\n}\n\nexport class RenderingCache {\n  protected renders = new Map<string, RenderingEntry>();\n\n  constructor(private options?: SsrOptimizationOptions) {}\n\n  setAsRendering(key: string) {\n    this.renders.set(key, { rendering: true });\n  }\n\n  isRendering(key: string): boolean {\n    return !!this.renders.get(key)?.rendering;\n  }\n\n  store(key: string, err?: Error | null, html?: string) {\n    const entry: RenderingEntry = { err, html };\n    if (this.options?.ttl) {\n      entry.time = Date.now();\n    }\n    if (this.options?.cacheSize) {\n      this.renders.delete(key);\n      if (this.renders.size >= this.options.cacheSize) {\n        this.renders.delete(this.renders.keys().next().value);\n      }\n    }\n    this.renders.set(key, entry);\n  }\n\n  get(key: string): RenderingEntry | undefined {\n    return this.renders.get(key);\n  }\n\n  clear(key: string) {\n    this.renders.delete(key);\n  }\n\n  isReady(key: string): boolean {\n    const entry = this.renders.get(key);\n    const isRenderPresent = entry?.html || entry?.err;\n    return isRenderPresent && this.isFresh(key);\n  }\n\n  isFresh(key: string): boolean {\n    if (!this.options?.ttl) {\n      return true;\n    }\n\n    return Date.now() - (this.renders.get(key)?.time ?? 0) < this.options?.ttl;\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Request } from 'express';\n\nexport interface SsrOptimizationOptions {\n  /**\n   * Time in milliseconds to wait for SSR rendering to happen.\n   */\n  timeout?: number;\n\n  /**\n   * Enable in-memory cache for pre-rendered urls.\n   *\n   * If disabled, the cache will still be used to temporarily store\n   * renders finished after csr fallback in order to serve them with\n   * next request only.\n   */\n  cache?: boolean;\n\n  /**\n   * Limit the cache size\n   *\n   * Specified number of entries that will be kept in cache, allows to keep\n   * memory usage under control.\n   *\n   * Can also be use when `cache` option is set to false. It will then limit the\n   * number of renders that timeouts and are kept in temporary cache, waiting\n   * to be served with next request.\n   */\n  cacheSize?: number;\n\n  /**\n   * Limit number of concurrent rendering\n   */\n  concurrency?: number;\n\n  /**\n   * Time in milliseconds after prerendered page is becoming stale and should\n   * be rendered again.\n   */\n  ttl?: number;\n\n  /**\n   * Allows overriding default key generator for custom differentiating\n   * between rendered pages. By default it uses the full request URL.\n   *\n   * @param req\n   */\n  renderKeyResolver?: (req: Request) => string;\n\n  /**\n   * Allows defining custom rendering strategy per request\n   *\n   * @param req\n   */\n  renderingStrategyResolver?: (req: Request) => RenderingStrategy;\n\n  /**\n   * Time in milliseconds to wait for rendering when SSR_ALWAYS render strategy is set for the request.\n   * Default value is 60000 milliseconds (1 minute).\n   */\n  forcedSsrTimeout?: number;\n\n  /**\n   * The time for how long the render is expected to finish in.\n   * Exceeding this timeout will decrease the concurrency limit\n   * and allow for the new request to be server-side rendered.\n   * However, this may not release the rendering resources for the hanging render,\n   * which may cause additional memory usage on the server.\n   *\n   * It will log which render is exceeding the render time,\n   * which is useful for debugging issues.\n   *\n   * The value should always be higher than `timeout` and `forcedSsrTimeout`.\n   *\n   * Default value is 300000 milliseconds (5 minutes).\n   */\n  maxRenderTime?: number;\n\n  /**\n   * Instead of immediately falling back to CSR\n   * while a render for the same key is in progress, this option will make\n   * the subsequent requests for this key wait for the current render.\n   *\n   * All pending requests that for the same rendering key will\n   * take up only _one_ concurrency slot, because there is only\n   * one actual rendering task being performed.\n   *\n   * Each request independently honors the `timeout` option.\n   * E.g., consider the following setup where `timeout` option\n   * is set to 3s, and the given request takes 4s to render.\n   * The flow is as follows:\n   *\n   * - 1st request arrives and triggers the SSR.\n   * - 2nd request for the same URL arrives 2s after the 1st one.\n   *    Instead of falling back to CSR, it waits (with its own timeout)\n   *    for the render of the first request.\n   * - 1st request times out after 3s, and falls back to CSR.\n   * - one second after the timeout, the current render finishes.\n   * - the 2nd request returns SSR after only 2s of waiting.\n   */\n  reuseCurrentRendering?: boolean;\n\n  /**\n   * Enable detailed logs for troubleshooting problems\n   */\n  debug?: boolean;\n}\n\nexport enum RenderingStrategy {\n  ALWAYS_CSR = -1,\n  DEFAULT = 0,\n  ALWAYS_SSR = 1,\n}\n\nexport const defaultSsrOptimizationOptions: SsrOptimizationOptions = {\n  concurrency: 10,\n  timeout: 3_000,\n  forcedSsrTimeout: 60_000,\n  maxRenderTime: 300_000,\n  reuseCurrentRendering: true,\n  debug: false,\n};\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\n/* webpackIgnore: true */\nimport { Request, Response } from 'express';\nimport * as fs from 'fs';\nimport { NgExpressEngineInstance } from '../engine-decorator/ng-express-engine-decorator';\nimport { getRequestUrl } from '../express-utils/express-request-url';\nimport { RenderingCache } from './rendering-cache';\nimport {\n  defaultSsrOptimizationOptions,\n  RenderingStrategy,\n  SsrOptimizationOptions,\n} from './ssr-optimization-options';\n\n/**\n * Returns the full url for the given SSR Request.\n */\nexport const getDefaultRenderKey = getRequestUrl;\n\nexport type SsrCallbackFn = (\n  /**\n   * Error that might've occurred while rendering.\n   */\n  err?: Error | null | undefined,\n  /**\n   * HTML response.\n   */\n  html?: string | undefined\n) => void;\n\n/**\n * The rendered pages are kept in memory to be served on next request. If the `cache` is set to `false`, the\n * response is evicted as soon as the first successful response is successfully returned.\n */\nexport class OptimizedSsrEngine {\n  protected currentConcurrency = 0;\n  protected renderingCache = new RenderingCache(this.ssrOptions);\n  private templateCache = new Map<string, string>();\n\n  /**\n   * When the config `reuseCurrentRendering` is enabled, we want perform\n   * only one render for one rendering key and reuse the html result\n   * for all the pending requests for the same rendering key.\n   * Therefore we need to store the callbacks for all the pending requests\n   * and invoke them with the html after the render completes.\n   *\n   * This Map should be used only when `reuseCurrentRendering` config is enabled.\n   * It's indexed by the rendering keys.\n   */\n  private renderCallbacks = new Map<string, SsrCallbackFn[]>();\n\n  get engineInstance(): NgExpressEngineInstance {\n    return this.renderResponse.bind(this);\n  }\n\n  constructor(\n    protected expressEngine: NgExpressEngineInstance,\n    protected ssrOptions?: SsrOptimizationOptions\n  ) {\n    this.ssrOptions = ssrOptions\n      ? {\n          ...defaultSsrOptimizationOptions,\n          // overrides the default options\n          ...ssrOptions,\n        }\n      : undefined;\n    this.logOptions();\n  }\n\n  protected logOptions(): void {\n    if (!this.ssrOptions) {\n      return;\n    }\n\n    const replacer = (_key: string, value: unknown): unknown => {\n      if (typeof value === 'function') {\n        return value.toString();\n      }\n      return value;\n    };\n\n    const stringifiedOptions = JSON.stringify(this.ssrOptions, replacer, 2);\n    this.log(\n      `[spartacus] SSR optimization engine initialized with the following options: ${stringifiedOptions}`,\n      false\n    );\n  }\n\n  /**\n   * When SSR page can not be returned in time, we're returning index.html of\n   * the CSR application.\n   * The CSR application is returned with the \"Cache-Control: no-store\" response-header. This notifies external cache systems to not use the CSR application for the subsequent request.\n   */\n  protected fallbackToCsr(\n    response: Response,\n    filePath: string,\n    callback: SsrCallbackFn\n  ): void {\n    response.set('Cache-Control', 'no-store');\n    callback(undefined, this.getDocument(filePath));\n  }\n\n  protected getRenderingKey(request: Request): string {\n    return this.ssrOptions?.renderKeyResolver\n      ? this.ssrOptions.renderKeyResolver(request)\n      : getDefaultRenderKey(request);\n  }\n\n  protected getRenderingStrategy(request: Request): RenderingStrategy {\n    return this.ssrOptions?.renderingStrategyResolver\n      ? this.ssrOptions.renderingStrategyResolver(request)\n      : RenderingStrategy.DEFAULT;\n  }\n\n  /**\n   * When returns true, the server side rendering should be performed.\n   * When returns false, the CSR fallback should be returned.\n   *\n   * We should not render, when there is already\n   * a pending rendering for the same rendering key\n   * (unless the `reuseCurrentRendering` config option is enabled)\n   * OR when the concurrency limit is exceeded.\n   */\n  protected shouldRender(request: Request): boolean {\n    const renderingKey = this.getRenderingKey(request);\n    const concurrencyLimitExceeded =\n      this.isConcurrencyLimitExceeded(renderingKey);\n    const fallBack =\n      this.renderingCache.isRendering(renderingKey) &&\n      !this.ssrOptions?.reuseCurrentRendering;\n\n    if (fallBack) {\n      this.log(`CSR fallback: rendering in progress (${request?.originalUrl})`);\n    } else if (concurrencyLimitExceeded) {\n      this.log(\n        `CSR fallback: Concurrency limit exceeded (${this.ssrOptions?.concurrency})`\n      );\n    }\n\n    return (\n      (!fallBack &&\n        !concurrencyLimitExceeded &&\n        this.getRenderingStrategy(request) !== RenderingStrategy.ALWAYS_CSR) ||\n      this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR\n    );\n  }\n\n  /**\n   * Checks for the concurrency limit\n   *\n   * @returns true if rendering this request would exceed the concurrency limit\n   */\n  private isConcurrencyLimitExceeded(renderingKey: string): boolean {\n    // If we can reuse a pending render for this request, we don't take up a new concurrency slot.\n    // In that case we don't exceed the concurrency limit even if the `currentConcurrency`\n    // already reaches the limit.\n    if (\n      this.ssrOptions?.reuseCurrentRendering &&\n      this.renderingCache.isRendering(renderingKey)\n    ) {\n      return false;\n    }\n\n    return this.ssrOptions?.concurrency\n      ? this.currentConcurrency >= this.ssrOptions.concurrency\n      : false;\n  }\n\n  /**\n   * Returns true, when the `timeout` option has been configured to non-zero value OR\n   * when the rendering strategy for the given request is ALWAYS_SSR.\n   * Otherwise, it returns false.\n   */\n  protected shouldTimeout(request: Request): boolean {\n    return (\n      !!this.ssrOptions?.timeout ||\n      this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR\n    );\n  }\n\n  /**\n   * Returns the timeout value.\n   *\n   * In case of the rendering strategy ALWAYS_SSR, it returns the config `forcedSsrTimeout`.\n   * Otherwise, it returns the config `timeout`.\n   */\n  protected getTimeout(request: Request): number {\n    return this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR\n      ? this.ssrOptions?.forcedSsrTimeout ?? 60000\n      : this.ssrOptions?.timeout ?? 0;\n  }\n\n  /**\n   * If there is an available cached response for this rendering key,\n   * it invokes the given render callback with the response and returns true.\n   *\n   * Otherwise, it returns false.\n   */\n  protected returnCachedRender(\n    request: Request,\n    callback: SsrCallbackFn\n  ): boolean {\n    const key = this.getRenderingKey(request);\n\n    if (this.renderingCache.isReady(key)) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const cached = this.renderingCache.get(key)!;\n      callback(cached.err, cached.html);\n\n      if (!this.ssrOptions?.cache) {\n        // we drop cached rendering if caching is disabled\n        this.renderingCache.clear(key);\n      }\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Handles the request and invokes the given `callback` with the result html / error.\n   *\n   * The result might be ether:\n   * - a CSR fallback with a basic `index.html` content\n   * - a result rendered by the original Angular Universal express engine\n   * - a result from the in-memory cache (which was previously rendered by Angular Universal express engine).\n   */\n  protected renderResponse(\n    filePath: string,\n    options: any,\n    callback: SsrCallbackFn\n  ): void {\n    const request: Request = options.req;\n    const response: Response = options.res || options.req.res;\n\n    if (this.returnCachedRender(request, callback)) {\n      this.log(`Render from cache (${request?.originalUrl})`);\n      return;\n    }\n    if (!this.shouldRender(request)) {\n      this.fallbackToCsr(response, filePath, callback);\n      return;\n    }\n\n    let requestTimeout: ReturnType<typeof setTimeout> | undefined;\n    if (this.shouldTimeout(request)) {\n      // establish timeout for rendering\n      const timeout = this.getTimeout(request);\n      requestTimeout = setTimeout(() => {\n        requestTimeout = undefined;\n        this.fallbackToCsr(response, filePath, callback);\n        this.log(\n          `SSR rendering exceeded timeout ${timeout}, fallbacking to CSR for ${request?.originalUrl}`,\n          false\n        );\n      }, timeout);\n    } else {\n      // Here we respond with the fallback to CSR, but we don't `return`.\n      // We let the actual rendering task to happen in the background\n      // to eventually store the rendered result in the cache.\n      this.fallbackToCsr(response, filePath, callback);\n    }\n\n    const renderingKey = this.getRenderingKey(request);\n    const renderCallback: SsrCallbackFn = (err, html): void => {\n      if (requestTimeout) {\n        // if request is still waiting for render, return it\n        clearTimeout(requestTimeout);\n        callback(err, html);\n\n        this.log(\n          `Request is resolved with the SSR rendering result (${request?.originalUrl})`\n        );\n\n        // store the render only if caching is enabled\n        if (this.ssrOptions?.cache) {\n          this.renderingCache.store(renderingKey, err, html);\n        } else {\n          this.renderingCache.clear(renderingKey);\n        }\n      } else {\n        // store the render for future use\n        this.renderingCache.store(renderingKey, err, html);\n      }\n    };\n\n    this.handleRender({\n      filePath,\n      options,\n      renderCallback,\n      request,\n    });\n  }\n\n  protected log(message: string, debug = true): void {\n    if (!debug || this.ssrOptions?.debug) {\n      console.log(message);\n    }\n  }\n\n  /** Retrieve the document from the cache or the filesystem */\n  protected getDocument(filePath: string): string {\n    let doc = this.templateCache.get(filePath);\n\n    if (!doc) {\n      doc = fs.readFileSync(filePath, 'utf-8');\n      this.templateCache.set(filePath, doc);\n    }\n\n    return doc;\n  }\n\n  /**\n   * Delegates the render to the original _Angular Universal express engine_.\n   *\n   * In case when the config `reuseCurrentRendering` is enabled and **if there is already a pending\n   * render task for the same rendering key**, it doesn't delegate a new render to Angular Universal.\n   * Instead, it waits for the current rendering to complete and then reuse the result for all waiting requests.\n   */\n  private handleRender({\n    filePath,\n    options,\n    renderCallback,\n    request,\n  }: {\n    filePath: string;\n    options: any;\n    renderCallback: SsrCallbackFn;\n    request: Request;\n  }): void {\n    if (!this.ssrOptions?.reuseCurrentRendering) {\n      this.startRender({\n        filePath,\n        options,\n        renderCallback,\n        request,\n      });\n      return;\n    }\n\n    const renderingKey = this.getRenderingKey(request);\n    if (!this.renderCallbacks.has(renderingKey)) {\n      this.renderCallbacks.set(renderingKey, []);\n    }\n    this.renderCallbacks.get(renderingKey)?.push(renderCallback);\n\n    if (!this.renderingCache.isRendering(renderingKey)) {\n      this.startRender({\n        filePath,\n        options,\n        request,\n        renderCallback: (err, html) => {\n          // Share the result of the render with all awaiting requests for the same key:\n\n          // Note: we access the Map at the moment of the render finished (don't store value in a local variable),\n          //       because in the meantime something might have deleted the value (i.e. when `maxRenderTime` passed).\n          this.renderCallbacks\n            .get(renderingKey)\n            ?.forEach((cb) => cb(err, html)); // pass the shared result to all waiting rendering callbacks\n          this.renderCallbacks.delete(renderingKey);\n        },\n      });\n    }\n\n    this.log(\n      `Request is waiting for the SSR rendering to complete (${request?.originalUrl})`\n    );\n  }\n\n  /**\n   * Delegates the render to the original _Angular Universal express engine_.\n   *\n   * There is no way to abort the running render of Angular Universal.\n   * So if the render doesn't complete in the configured `maxRenderTime`,\n   * we just consider the render task as hanging (note: it's a potential memory leak!).\n   * Later on, even if the render completes somewhen in the future, we will ignore\n   * its result.\n   */\n  private startRender({\n    filePath,\n    options,\n    renderCallback,\n    request,\n  }: {\n    filePath: string;\n    options: any;\n    renderCallback: SsrCallbackFn;\n    request: Request;\n  }): void {\n    const renderingKey = this.getRenderingKey(request);\n\n    // Setting the timeout for hanging renders that might not ever finish due to various reasons.\n    // After the configured `maxRenderTime` passes, we consider the rendering task as hanging,\n    // and release the concurrency slot and forget all callbacks waiting for the render's result.\n    let maxRenderTimeout: ReturnType<typeof setTimeout> | undefined =\n      setTimeout(() => {\n        this.renderingCache.clear(renderingKey);\n        maxRenderTimeout = undefined;\n        this.currentConcurrency--;\n        if (this.ssrOptions?.reuseCurrentRendering) {\n          this.renderCallbacks.delete(renderingKey);\n        }\n        this.log(\n          `Rendering of ${request?.originalUrl} was not able to complete. This might cause memory leaks!`,\n          false\n        );\n      }, this.ssrOptions?.maxRenderTime ?? 300000); // 300000ms == 5 minutes\n\n    this.log(`Rendering started (${request?.originalUrl})`);\n    this.renderingCache.setAsRendering(renderingKey);\n    this.currentConcurrency++;\n\n    this.expressEngine(filePath, options, (err, html) => {\n      if (!maxRenderTimeout) {\n        // ignore this render's result because it exceeded maxRenderTimeout\n        this.log(\n          `Rendering of ${request.originalUrl} completed after the specified maxRenderTime, therefore it was ignored.`,\n          false\n        );\n        return;\n      }\n      clearTimeout(maxRenderTimeout);\n\n      this.log(`Rendering completed (${request?.originalUrl})`);\n      this.currentConcurrency--;\n\n      renderCallback(err, html);\n    });\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { inject } from '@angular/core';\nimport { SERVER_REQUEST_ORIGIN } from '@spartacus/core';\nimport { ServerOptions } from './model';\n\n/**\n * Returns a factory function which resolves the server request origin.\n */\nexport function serverRequestOriginFactory(options?: ServerOptions): Function {\n  return (): string => {\n    const serverRequestOrigin = inject(SERVER_REQUEST_ORIGIN, {\n      optional: true,\n      skipSelf: true,\n    });\n\n    // usually prerendering mode, but can be SSR\n    if (options?.serverRequestOrigin) {\n      return options.serverRequestOrigin;\n    }\n\n    // SSR mode, from express engine\n    if (serverRequestOrigin) {\n      return serverRequestOrigin;\n    }\n\n    throw new Error(\n      `The request origin is not set. \n    If you are using the default environment variable, please specify it when initiating the process.\n    \n    E.g.\n    > SERVER_REQUEST_ORIGIN=https://my.domain.com yarn prerender\n    > SERVER_REQUEST_ORIGIN=http://localhost:4200 yarn serve:ssr\n    \n    \n    Alternatively, you can pass it as an argument to provideServer\n    function, but beware it will be used for server-side rendering as well.\n    \n    E.g.\n    @NgModule({\n      // ...\n      providers: [\n        provideServer({\n          serverRequestOrigin: 'https://my.domain.com',\n        }),\n      ],\n    })\n    export class AppServerModule {}`\n    );\n  };\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { inject } from '@angular/core';\nimport { INITIAL_CONFIG } from '@angular/platform-server';\nimport { SERVER_REQUEST_ORIGIN, SERVER_REQUEST_URL } from '@spartacus/core';\nimport { ServerOptions } from './model';\n\n/**\n * Returns a factory function which resolves the server request URL.\n */\nexport function serverRequestUrlFactory(options?: ServerOptions): Function {\n  return (): string => {\n    const platformConfig = inject(INITIAL_CONFIG);\n    const serverRequestOrigin = inject(SERVER_REQUEST_ORIGIN);\n    const serverRequestUrl = inject(SERVER_REQUEST_URL, {\n      optional: true,\n      skipSelf: true,\n    });\n\n    // SSR mode\n    if (serverRequestUrl) {\n      // should override the automatically recognized origin\n      if (options?.serverRequestOrigin) {\n        return serverRequestUrl.replace(\n          serverRequestOrigin,\n          options.serverRequestOrigin\n        );\n      }\n\n      return serverRequestUrl;\n    }\n\n    // prerendering mode (no express server)\n    return serverRequestOrigin + platformConfig.url;\n  };\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { StaticProvider } from '@angular/core';\nimport { REQUEST } from '@nguniversal/express-engine/tokens';\nimport { SERVER_REQUEST_ORIGIN, SERVER_REQUEST_URL } from '@spartacus/core';\nimport { getRequestOrigin } from '../express-utils/express-request-origin';\nimport { getRequestUrl } from '../express-utils/express-request-url';\nimport { ServerOptions } from './model';\nimport { serverRequestOriginFactory } from './server-request-origin';\nimport { serverRequestUrlFactory } from './server-request-url';\n\n/**\n * Returns the providers used for SSR and pre-rendering processes.\n */\nexport function provideServer(options?: ServerOptions): StaticProvider[] {\n  return [\n    {\n      provide: SERVER_REQUEST_ORIGIN,\n      useFactory: serverRequestOriginFactory(options),\n    },\n    {\n      provide: SERVER_REQUEST_URL,\n      useFactory: serverRequestUrlFactory(options),\n    },\n  ];\n}\n\n/**\n * Returns Spartacus providers to be passed to the Angular express engine (in SSR)\n *\n * @param options\n */\nexport function getServerRequestProviders(): StaticProvider[] {\n  return [\n    {\n      provide: SERVER_REQUEST_ORIGIN,\n      useFactory: getRequestOrigin,\n      deps: [REQUEST],\n    },\n    {\n      provide: SERVER_REQUEST_URL,\n      useFactory: getRequestUrl,\n      deps: [REQUEST],\n    },\n  ];\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { NgSetupOptions } from '@nguniversal/express-engine';\nimport {\n  OptimizedSsrEngine,\n  SsrCallbackFn,\n} from '../optimized-engine/optimized-ssr-engine';\nimport {\n  SsrOptimizationOptions,\n  defaultSsrOptimizationOptions,\n} from '../optimized-engine/ssr-optimization-options';\nimport { getServerRequestProviders } from '../providers/ssr-providers';\n\nexport type NgExpressEngineInstance = (\n  filePath: string,\n  options: object,\n  callback: SsrCallbackFn\n) => void;\n\nexport type NgExpressEngine = (\n  setupOptions: Readonly<NgSetupOptions>\n) => NgExpressEngineInstance;\n\n/**\n * The wrapper over the standard ngExpressEngine, that provides tokens for Spartacus\n * @param ngExpressEngine\n */\nexport class NgExpressEngineDecorator {\n  /**\n   * Returns the higher order ngExpressEngine with provided tokens for Spartacus\n   *\n   * @param ngExpressEngine\n   */\n  static get(\n    ngExpressEngine: NgExpressEngine,\n    optimizationOptions?: SsrOptimizationOptions | null\n  ): NgExpressEngine {\n    return decorateExpressEngine(ngExpressEngine, optimizationOptions);\n  }\n}\n\nexport function decorateExpressEngine(\n  ngExpressEngine: NgExpressEngine,\n  optimizationOptions:\n    | SsrOptimizationOptions\n    | null\n    | undefined = defaultSsrOptimizationOptions\n): NgExpressEngine {\n  return function (setupOptions: NgSetupOptions) {\n    const engineInstance = ngExpressEngine({\n      ...setupOptions,\n      providers: [\n        // add spartacus related providers\n        ...getServerRequestProviders(),\n        ...(setupOptions.providers ?? []),\n      ],\n    });\n\n    // apply optimization wrapper if optimization options were defined\n    return optimizationOptions\n      ? new OptimizedSsrEngine(engineInstance, optimizationOptions)\n          .engineInstance\n      : engineInstance;\n  };\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport { NgExpressEngineDecorator } from './ng-express-engine-decorator';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './optimized-ssr-engine';\nexport * from './rendering-cache';\nexport * from './ssr-optimization-options';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './model';\nexport * from './ssr-providers';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './engine-decorator/index';\nexport * from './optimized-engine/index';\nexport * from './providers/index';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}