/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { CartType } from '@spartacus/cart/base/root';
import { isNotUndefined, OCC_CART_ID_CURRENT } from '@spartacus/core';
import { filter, map } from 'rxjs/operators';
import { isSelectiveCart } from '../../utils/utils';
import { CartActions } from '../actions/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
export class MultiCartEffects {
    /**
     * Verifies if cart is the current cart and returns the appropriate cart type
     * @param action
     * @returns cart type needed on load
     */
    getActiveCartTypeOnLoad(action) {
        if (action?.payload?.cartId === OCC_CART_ID_CURRENT) {
            return new CartActions.SetCartTypeIndex({
                cartType: CartType.ACTIVE,
                cartId: '',
            });
        }
        return undefined;
    }
    /**
     * Verifies if cart is active and returns the appropriate cart type
     * @param action
     * @returns cart type needed on creation
     */
    getActiveCartTypeOnCreate(action) {
        if (action?.payload?.extraData?.active) {
            return new CartActions.SetCartTypeIndex({
                cartType: CartType.ACTIVE,
                cartId: action.meta.entityId,
            });
        }
        return undefined;
    }
    constructor(actions$) {
        this.actions$ = actions$;
        // TODO(#7241): Remove when we drop ADD_VOUCHER process and we sort out checkout and cart dependencies
        this.processesIncrement$ = createEffect(() => this.actions$.pipe(ofType(CartActions.CART_ADD_VOUCHER), map((action) => action.payload), map((payload) => new CartActions.CartProcessesIncrement(payload.cartId))));
        this.setSelectiveId$ = createEffect(() => this.actions$.pipe(ofType(CartActions.LOAD_CART_SUCCESS), map((action) => {
            switch (action.type) {
                case CartActions.LOAD_CART_SUCCESS: {
                    const payload = action.payload;
                    if (isSelectiveCart(payload.cartId)) {
                        return new CartActions.SetCartTypeIndex({
                            cartType: CartType.SELECTIVE,
                            cartId: payload.cartId,
                        });
                    }
                    break;
                }
            }
        }), filter(isNotUndefined)));
        this.setActiveCartId$ = createEffect(() => this.actions$.pipe(ofType(CartActions.LOAD_CART_SUCCESS, CartActions.LOAD_CART, CartActions.CREATE_CART_SUCCESS, CartActions.CREATE_CART, CartActions.SET_ACTIVE_CART_ID), map((action) => {
            switch (action.type) {
                case CartActions.LOAD_CART: {
                    return this.getActiveCartTypeOnLoad(action);
                }
                case CartActions.LOAD_CART_SUCCESS: {
                    if (action?.payload?.extraData?.active) {
                        // saved cart is not active cart
                        if (action.payload?.cart.saveTime) {
                            return new CartActions.SetCartTypeIndex({
                                cartType: CartType.ACTIVE,
                                cartId: '',
                            });
                        }
                        return new CartActions.SetCartTypeIndex({
                            cartType: CartType.ACTIVE,
                            cartId: action.meta.entityId,
                        });
                    }
                    break;
                }
                case CartActions.CREATE_CART: {
                    return this.getActiveCartTypeOnCreate(action);
                }
                case CartActions.CREATE_CART_SUCCESS: {
                    return new CartActions.SetCartTypeIndex({
                        cartType: action?.payload?.extraData?.active
                            ? CartType.ACTIVE
                            : CartType.NEW_CREATED,
                        cartId: action.meta.entityId,
                    });
                }
                case CartActions.SET_ACTIVE_CART_ID:
                    return new CartActions.SetCartTypeIndex({
                        cartType: CartType.ACTIVE,
                        cartId: action.payload,
                    });
            }
            return undefined;
        }), filter(isNotUndefined)));
    }
}
MultiCartEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: MultiCartEffects, deps: [{ token: i1.Actions }], target: i0.ɵɵFactoryTarget.Injectable });
MultiCartEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: MultiCartEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: MultiCartEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGktY2FydC5lZmZlY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9iYXNlL2NvcmUvc3RvcmUvZWZmZWN0cy9tdWx0aS1jYXJ0LmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQVcsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU5RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDckQsT0FBTyxFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXRFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7O0FBRy9DLE1BQU0sT0FBTyxnQkFBZ0I7SUF1RjNCOzs7O09BSUc7SUFDSyx1QkFBdUIsQ0FDN0IsTUFBNEI7UUFFNUIsSUFBSSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sS0FBSyxtQkFBbUIsRUFBRTtZQUNuRCxPQUFPLElBQUksV0FBVyxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QyxRQUFRLEVBQUUsUUFBUSxDQUFDLE1BQU07Z0JBQ3pCLE1BQU0sRUFBRSxFQUFFO2FBQ1gsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLHlCQUF5QixDQUMvQixNQUE4QjtRQUU5QixJQUFJLE1BQU0sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRTtZQUN0QyxPQUFPLElBQUksV0FBVyxDQUFDLGdCQUFn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QUFPLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDL0M7Z0JBQ0QsS0FBSyxXQUFXLENBQUMsbUJBQW1CLENBQUMsQ0FBQztvQkFDcEMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDdEMsUUFBUSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU07NEJBQzFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTTs0QkFDakIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXO3dCQUN4QixNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFrQjtxQkFDdkMsQ0FBQyxDQUFDO2lCQUNKO2dCQUNELEtBQUssV0FBVyxDQUFDLGtCQUFrQjtvQkFDakMsT0FBTyxJQUFJLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDdEMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxNQUFNO3dCQUN6QixNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU87cUJBQ3ZCLENBQUMsQ0FBQzthQUNOO1lBQ0QsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQyxDQUFDLEVBQ0YsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUN2QixDQUNKLENBQUM7SUFvQ3NDLENBQUM7OzZHQXpIOUIsZ0JBQWdCO2lIQUFoQixnQkFBZ0I7MkZBQWhCLGdCQUFnQjtrQkFENUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGlvbnMsIGNyZWF0ZUVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBDYXJ0VHlwZSB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL3Jvb3QnO1xuaW1wb3J0IHsgaXNOb3RVbmRlZmluZWQsIE9DQ19DQVJUX0lEX0NVUlJFTlQgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBpc1NlbGVjdGl2ZUNhcnQgfSBmcm9tICcuLi8uLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBDYXJ0QWN0aW9ucyB9IGZyb20gJy4uL2FjdGlvbnMvaW5kZXgnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTXVsdGlDYXJ0RWZmZWN0cyB7XG4gIC8vIFRPRE8oIzcyNDEpOiBSZW1vdmUgd2hlbiB3ZSBkcm9wIEFERF9WT1VDSEVSIHByb2Nlc3MgYW5kIHdlIHNvcnQgb3V0IGNoZWNrb3V0IGFuZCBjYXJ0IGRlcGVuZGVuY2llc1xuXG4gIHByb2Nlc3Nlc0luY3JlbWVudCQ6IE9ic2VydmFibGU8Q2FydEFjdGlvbnMuQ2FydFByb2Nlc3Nlc0luY3JlbWVudD4gPVxuICAgIGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgICBvZlR5cGUoQ2FydEFjdGlvbnMuQ0FSVF9BRERfVk9VQ0hFUiksXG4gICAgICAgIG1hcCgoYWN0aW9uOiBDYXJ0QWN0aW9ucy5DYXJ0QWRkVm91Y2hlcikgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgICBtYXAoKHBheWxvYWQpID0+IG5ldyBDYXJ0QWN0aW9ucy5DYXJ0UHJvY2Vzc2VzSW5jcmVtZW50KHBheWxvYWQuY2FydElkKSlcbiAgICAgIClcbiAgICApO1xuXG4gIHNldFNlbGVjdGl2ZUlkJDogT2JzZXJ2YWJsZTxDYXJ0QWN0aW9ucy5TZXRDYXJ0VHlwZUluZGV4PiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDYXJ0QWN0aW9ucy5MT0FEX0NBUlRfU1VDQ0VTUyksXG4gICAgICBtYXAoKGFjdGlvbjogQWN0aW9uKSA9PiB7XG4gICAgICAgIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICAgICAgICBjYXNlIENhcnRBY3Rpb25zLkxPQURfQ0FSVF9TVUNDRVNTOiB7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gKGFjdGlvbiBhcyBDYXJ0QWN0aW9ucy5Mb2FkQ2FydFN1Y2Nlc3MpLnBheWxvYWQ7XG4gICAgICAgICAgICBpZiAoaXNTZWxlY3RpdmVDYXJ0KHBheWxvYWQuY2FydElkKSkge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXgoe1xuICAgICAgICAgICAgICAgIGNhcnRUeXBlOiBDYXJ0VHlwZS5TRUxFQ1RJVkUsXG4gICAgICAgICAgICAgICAgY2FydElkOiBwYXlsb2FkLmNhcnRJZCxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZmlsdGVyKGlzTm90VW5kZWZpbmVkKVxuICAgIClcbiAgKTtcblxuICBzZXRBY3RpdmVDYXJ0SWQkOiBPYnNlcnZhYmxlPENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXg+ID0gY3JlYXRlRWZmZWN0KFxuICAgICgpID0+XG4gICAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICAgIG9mVHlwZShcbiAgICAgICAgICBDYXJ0QWN0aW9ucy5MT0FEX0NBUlRfU1VDQ0VTUyxcbiAgICAgICAgICBDYXJ0QWN0aW9ucy5MT0FEX0NBUlQsXG4gICAgICAgICAgQ2FydEFjdGlvbnMuQ1JFQVRFX0NBUlRfU1VDQ0VTUyxcbiAgICAgICAgICBDYXJ0QWN0aW9ucy5DUkVBVEVfQ0FSVCxcbiAgICAgICAgICBDYXJ0QWN0aW9ucy5TRVRfQUNUSVZFX0NBUlRfSURcbiAgICAgICAgKSxcbiAgICAgICAgbWFwKChhY3Rpb246IENhcnRBY3Rpb25zLkNhcnRBY3Rpb24gfCBDYXJ0QWN0aW9ucy5TZXRBY3RpdmVDYXJ0SWQpID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIENhcnRBY3Rpb25zLkxPQURfQ0FSVDoge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRBY3RpdmVDYXJ0VHlwZU9uTG9hZChhY3Rpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSBDYXJ0QWN0aW9ucy5MT0FEX0NBUlRfU1VDQ0VTUzoge1xuICAgICAgICAgICAgICBpZiAoYWN0aW9uPy5wYXlsb2FkPy5leHRyYURhdGE/LmFjdGl2ZSkge1xuICAgICAgICAgICAgICAgIC8vIHNhdmVkIGNhcnQgaXMgbm90IGFjdGl2ZSBjYXJ0XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkPy5jYXJ0LnNhdmVUaW1lKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXgoe1xuICAgICAgICAgICAgICAgICAgICBjYXJ0VHlwZTogQ2FydFR5cGUuQUNUSVZFLFxuICAgICAgICAgICAgICAgICAgICBjYXJ0SWQ6ICcnLFxuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQ2FydEFjdGlvbnMuU2V0Q2FydFR5cGVJbmRleCh7XG4gICAgICAgICAgICAgICAgICBjYXJ0VHlwZTogQ2FydFR5cGUuQUNUSVZFLFxuICAgICAgICAgICAgICAgICAgY2FydElkOiBhY3Rpb24ubWV0YS5lbnRpdHlJZCBhcyBzdHJpbmcsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlIENhcnRBY3Rpb25zLkNSRUFURV9DQVJUOiB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEFjdGl2ZUNhcnRUeXBlT25DcmVhdGUoYWN0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgQ2FydEFjdGlvbnMuQ1JFQVRFX0NBUlRfU1VDQ0VTUzoge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXgoe1xuICAgICAgICAgICAgICAgIGNhcnRUeXBlOiBhY3Rpb24/LnBheWxvYWQ/LmV4dHJhRGF0YT8uYWN0aXZlXG4gICAgICAgICAgICAgICAgICA/IENhcnRUeXBlLkFDVElWRVxuICAgICAgICAgICAgICAgICAgOiBDYXJ0VHlwZS5ORVdfQ1JFQVRFRCxcbiAgICAgICAgICAgICAgICBjYXJ0SWQ6IGFjdGlvbi5tZXRhLmVudGl0eUlkIGFzIHN0cmluZyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlIENhcnRBY3Rpb25zLlNFVF9BQ1RJVkVfQ0FSVF9JRDpcbiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0QWN0aW9ucy5TZXRDYXJ0VHlwZUluZGV4KHtcbiAgICAgICAgICAgICAgICBjYXJ0VHlwZTogQ2FydFR5cGUuQUNUSVZFLFxuICAgICAgICAgICAgICAgIGNhcnRJZDogYWN0aW9uLnBheWxvYWQsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9KSxcbiAgICAgICAgZmlsdGVyKGlzTm90VW5kZWZpbmVkKVxuICAgICAgKVxuICApO1xuXG4gIC8qKlxuICAgKiBWZXJpZmllcyBpZiBjYXJ0IGlzIHRoZSBjdXJyZW50IGNhcnQgYW5kIHJldHVybnMgdGhlIGFwcHJvcHJpYXRlIGNhcnQgdHlwZVxuICAgKiBAcGFyYW0gYWN0aW9uXG4gICAqIEByZXR1cm5zIGNhcnQgdHlwZSBuZWVkZWQgb24gbG9hZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRBY3RpdmVDYXJ0VHlwZU9uTG9hZChcbiAgICBhY3Rpb246IENhcnRBY3Rpb25zLkxvYWRDYXJ0XG4gICk6IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXggfCB1bmRlZmluZWQge1xuICAgIGlmIChhY3Rpb24/LnBheWxvYWQ/LmNhcnRJZCA9PT0gT0NDX0NBUlRfSURfQ1VSUkVOVCkge1xuICAgICAgcmV0dXJuIG5ldyBDYXJ0QWN0aW9ucy5TZXRDYXJ0VHlwZUluZGV4KHtcbiAgICAgICAgY2FydFR5cGU6IENhcnRUeXBlLkFDVElWRSxcbiAgICAgICAgY2FydElkOiAnJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmaWVzIGlmIGNhcnQgaXMgYWN0aXZlIGFuZCByZXR1cm5zIHRoZSBhcHByb3ByaWF0ZSBjYXJ0IHR5cGVcbiAgICogQHBhcmFtIGFjdGlvblxuICAgKiBAcmV0dXJucyBjYXJ0IHR5cGUgbmVlZGVkIG9uIGNyZWF0aW9uXG4gICAqL1xuICBwcml2YXRlIGdldEFjdGl2ZUNhcnRUeXBlT25DcmVhdGUoXG4gICAgYWN0aW9uOiBDYXJ0QWN0aW9ucy5DcmVhdGVDYXJ0XG4gICk6IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXggfCB1bmRlZmluZWQge1xuICAgIGlmIChhY3Rpb24/LnBheWxvYWQ/LmV4dHJhRGF0YT8uYWN0aXZlKSB7XG4gICAgICByZXR1cm4gbmV3IENhcnRBY3Rpb25zLlNldENhcnRUeXBlSW5kZXgoe1xuICAgICAgICBjYXJ0VHlwZTogQ2FydFR5cGUuQUNUSVZFLFxuICAgICAgICBjYXJ0SWQ6IGFjdGlvbi5tZXRhLmVudGl0eUlkIGFzIHN0cmluZyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhY3Rpb25zJDogQWN0aW9ucykge31cbn1cbiJdfQ==