/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { CartType, } from '@spartacus/cart/base/root';
import { OCC_USER_ID_ANONYMOUS, } from '@spartacus/core';
import { combineLatest } from 'rxjs';
import { distinctUntilChanged, filter, shareReplay, switchMap, take, tap, withLatestFrom, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/user/profile/root";
import * as i2 from "@spartacus/cart/base/root";
import * as i3 from "@spartacus/core";
export class SelectiveCartService {
    constructor(userProfileFacade, multiCartFacade, baseSiteService, userIdService) {
        this.userProfileFacade = userProfileFacade;
        this.multiCartFacade = multiCartFacade;
        this.baseSiteService = baseSiteService;
        this.userIdService = userIdService;
    }
    /**
     * Initialize the stream when first call this function
     */
    getCart() {
        if (!this.selectiveCart$) {
            this.selectiveCart$ = combineLatest([
                this.getSelectiveCartId(),
                this.userProfileFacade.get(),
                this.userIdService.getUserId(),
                this.baseSiteService.getActive(),
            ]).pipe(distinctUntilChanged(), tap(([selectiveId, user, userId, activeBaseSite]) => {
                if (!Boolean(selectiveId) &&
                    userId !== OCC_USER_ID_ANONYMOUS &&
                    user?.customerId) {
                    this.multiCartFacade.loadCart({
                        userId: userId,
                        cartId: `selectivecart${activeBaseSite}${user.customerId}`,
                    });
                }
            }), filter(([selectiveId]) => Boolean(selectiveId)), switchMap(([selectiveId]) => this.multiCartFacade.getCart(selectiveId)), shareReplay({ bufferSize: 1, refCount: true }));
        }
        return this.selectiveCart$;
    }
    getEntries() {
        return this.getSelectiveCartId().pipe(switchMap((selectiveId) => this.multiCartFacade.getEntries(selectiveId)));
    }
    isStable() {
        return this.getSelectiveCartId().pipe(switchMap((selectiveId) => this.multiCartFacade.isStable(selectiveId)));
    }
    addEntry(productCode, quantity) {
        this.getSelectiveIdWithUserId().subscribe(([selectiveId, userId]) => {
            this.multiCartFacade.addEntry(userId, selectiveId, productCode, quantity);
        });
    }
    removeEntry(entry) {
        this.getSelectiveIdWithUserId().subscribe(([selectiveId, userId]) => {
            this.multiCartFacade.removeEntry(userId, selectiveId, entry.entryNumber);
        });
    }
    updateEntry(entryNumber, quantity) {
        this.getSelectiveIdWithUserId().subscribe(([selectiveId, userId]) => {
            this.multiCartFacade.updateEntry(userId, selectiveId, entryNumber, quantity);
        });
    }
    getEntry(productCode) {
        return this.getSelectiveCartId().pipe(switchMap((selectiveId) => this.multiCartFacade.getEntry(selectiveId, productCode)));
    }
    getSelectiveCartId() {
        return this.multiCartFacade.getCartIdByType(CartType.SELECTIVE);
    }
    getSelectiveIdWithUserId() {
        return this.getSelectiveCartId().pipe(distinctUntilChanged(), withLatestFrom(this.userIdService.getUserId()), take(1));
    }
}
SelectiveCartService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: SelectiveCartService, deps: [{ token: i1.UserProfileFacade }, { token: i2.MultiCartFacade }, { token: i3.BaseSiteService }, { token: i3.UserIdService }], target: i0.ɵɵFactoryTarget.Injectable });
SelectiveCartService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: SelectiveCartService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: SelectiveCartService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.UserProfileFacade }, { type: i2.MultiCartFacade }, { type: i3.BaseSiteService }, { type: i3.UserIdService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aXZlLWNhcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9jYXJ0L2Jhc2UvY29yZS9mYWNhZGUvc2VsZWN0aXZlLWNhcnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBRUwsUUFBUSxHQUlULE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUVMLHFCQUFxQixHQUV0QixNQUFNLGlCQUFpQixDQUFDO0FBRXpCLE9BQU8sRUFBRSxhQUFhLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUNMLG9CQUFvQixFQUNwQixNQUFNLEVBQ04sV0FBVyxFQUNYLFNBQVMsRUFDVCxJQUFJLEVBQ0osR0FBRyxFQUNILGNBQWMsR0FDZixNQUFNLGdCQUFnQixDQUFDOzs7OztBQUd4QixNQUFNLE9BQU8sb0JBQW9CO0lBRy9CLFlBQ1ksaUJBQW9DLEVBQ3BDLGVBQWdDLEVBQ2hDLGVBQWdDLEVBQ2hDLGFBQTRCO1FBSDVCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUNyQyxDQUFDO0lBRUo7O09BRUc7SUFDSCxPQUFPO1FBQ0wsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDeEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtnQkFDekIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUU7Z0JBQzlCLElBQUksQ0FBQyxlQUFlLENBQUMs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QyxDQUN4RCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRVMsa0JBQWtCO1FBQzFCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFTyx3QkFBd0I7UUFDOUIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxJQUFJLENBQ25DLG9CQUFvQixFQUFFLEVBQ3RCLGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFDLEVBQzlDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUixDQUFDO0lBQ0osQ0FBQzs7aUhBbkdVLG9CQUFvQjtxSEFBcEIsb0JBQW9COzJGQUFwQixvQkFBb0I7a0JBRGhDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBDYXJ0LFxuICBDYXJ0VHlwZSxcbiAgTXVsdGlDYXJ0RmFjYWRlLFxuICBPcmRlckVudHJ5LFxuICBTZWxlY3RpdmVDYXJ0RmFjYWRlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9yb290JztcbmltcG9ydCB7XG4gIEJhc2VTaXRlU2VydmljZSxcbiAgT0NDX1VTRVJfSURfQU5PTllNT1VTLFxuICBVc2VySWRTZXJ2aWNlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgVXNlclByb2ZpbGVGYWNhZGUgfSBmcm9tICdAc3BhcnRhY3VzL3VzZXIvcHJvZmlsZS9yb290JztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICBmaWx0ZXIsXG4gIHNoYXJlUmVwbGF5LFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRhcCxcbiAgd2l0aExhdGVzdEZyb20sXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNlbGVjdGl2ZUNhcnRTZXJ2aWNlIGltcGxlbWVudHMgU2VsZWN0aXZlQ2FydEZhY2FkZSB7XG4gIHByb3RlY3RlZCBzZWxlY3RpdmVDYXJ0JDogT2JzZXJ2YWJsZTxDYXJ0PjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgdXNlclByb2ZpbGVGYWNhZGU6IFVzZXJQcm9maWxlRmFjYWRlLFxuICAgIHByb3RlY3RlZCBtdWx0aUNhcnRGYWNhZGU6IE11bHRpQ2FydEZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgYmFzZVNpdGVTZXJ2aWNlOiBCYXNlU2l0ZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHVzZXJJZFNlcnZpY2U6IFVzZXJJZFNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHRoZSBzdHJlYW0gd2hlbiBmaXJzdCBjYWxsIHRoaXMgZnVuY3Rpb25cbiAgICovXG4gIGdldENhcnQoKTogT2JzZXJ2YWJsZTxDYXJ0PiB7XG4gICAgaWYgKCF0aGlzLnNlbGVjdGl2ZUNhcnQkKSB7XG4gICAgICB0aGlzLnNlbGVjdGl2ZUNhcnQkID0gY29tYmluZUxhdGVzdChbXG4gICAgICAgIHRoaXMuZ2V0U2VsZWN0aXZlQ2FydElkKCksXG4gICAgICAgIHRoaXMudXNlclByb2ZpbGVGYWNhZGUuZ2V0KCksXG4gICAgICAgIHRoaXMudXNlcklkU2VydmljZS5nZXRVc2VySWQoKSxcbiAgICAgICAgdGhpcy5iYXNlU2l0ZVNlcnZpY2UuZ2V0QWN0aXZlKCksXG4gICAgICBdKS5waXBlKFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICB0YXAoKFtzZWxlY3RpdmVJZCwgdXNlciwgdXNlcklkLCBhY3RpdmVCYXNlU2l0ZV0pID0+IHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAhQm9vbGVhbihzZWxlY3RpdmVJZCkgJiZcbiAgICAgICAgICAgIHVzZXJJZCAhPT0gT0NDX1VTRVJfSURfQU5PTllNT1VTICYmXG4gICAgICAgICAgICB1c2VyPy5jdXN0b21lcklkXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICB0aGlzLm11bHRpQ2FydEZhY2FkZS5sb2FkQ2FydCh7XG4gICAgICAgICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICAgICAgICBjYXJ0SWQ6IGBzZWxlY3RpdmVjYXJ0JHthY3RpdmVCYXNlU2l0ZX0ke3VzZXIuY3VzdG9tZXJJZH1gLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgZmlsdGVyKChbc2VsZWN0aXZlSWRdKSA9PiBCb29sZWFuKHNlbGVjdGl2ZUlkKSksXG4gICAgICAgIHN3aXRjaE1hcCgoW3NlbGVjdGl2ZUlkXSkgPT4gdGhpcy5tdWx0aUNhcnRGYWNhZGUuZ2V0Q2FydChzZWxlY3RpdmVJZCkpLFxuICAgICAgICBzaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiB0cnVlIH0pXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zZWxlY3RpdmVDYXJ0JDtcbiAgfVxuXG4gIGdldEVudHJpZXMoKTogT2JzZXJ2YWJsZTxPcmRlckVudHJ5W10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZWxlY3RpdmVDYXJ0SWQoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChzZWxlY3RpdmVJZCkgPT4gdGhpcy5tdWx0aUNhcnRGYWNhZGUuZ2V0RW50cmllcyhzZWxlY3RpdmVJZCkpXG4gICAgKTtcbiAgfVxuXG4gIGlzU3RhYmxlKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmdldFNlbGVjdGl2ZUNhcnRJZCgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKHNlbGVjdGl2ZUlkKSA9PiB0aGlzLm11bHRpQ2FydEZhY2FkZS5pc1N0YWJsZShzZWxlY3RpdmVJZCkpXG4gICAgKTtcbiAgfVxuXG4gIGFkZEVudHJ5KHByb2R1Y3RDb2RlOiBzdHJpbmcsIHF1YW50aXR5OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmdldFNlbGVjdGl2ZUlkV2l0aFVzZXJJZCgpLnN1YnNjcmliZSgoW3NlbGVjdGl2ZUlkLCB1c2VySWRdKSA9PiB7XG4gICAgICB0aGlzLm11bHRpQ2FydEZhY2FkZS5hZGRFbnRyeSh1c2VySWQsIHNlbGVjdGl2ZUlkLCBwcm9kdWN0Q29kZSwgcXVhbnRpdHkpO1xuICAgIH0pO1xuICB9XG5cbiAgcmVtb3ZlRW50cnkoZW50cnk6IE9yZGVyRW50cnkpOiB2b2lkIHtcbiAgICB0aGlzLmdldFNlbGVjdGl2ZUlkV2l0aFVzZXJJZCgpLnN1YnNjcmliZSgoW3NlbGVjdGl2ZUlkLCB1c2VySWRdKSA9PiB7XG4gICAgICB0aGlzLm11bHRpQ2FydEZhY2FkZS5yZW1vdmVFbnRyeShcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBzZWxlY3RpdmVJZCxcbiAgICAgICAgZW50cnkuZW50cnlOdW1iZXIgYXMgbnVtYmVyXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlRW50cnkoZW50cnlOdW1iZXI6IG51bWJlciwgcXVhbnRpdHk6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuZ2V0U2VsZWN0aXZlSWRXaXRoVXNlcklkKCkuc3Vic2NyaWJlKChbc2VsZWN0aXZlSWQsIHVzZXJJZF0pID0+IHtcbiAgICAgIHRoaXMubXVsdGlDYXJ0RmFjYWRlLnVwZGF0ZUVudHJ5KFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHNlbGVjdGl2ZUlkLFxuICAgICAgICBlbnRyeU51bWJlcixcbiAgICAgICAgcXVhbnRpdHlcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRFbnRyeShwcm9kdWN0Q29kZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxPcmRlckVudHJ5IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U2VsZWN0aXZlQ2FydElkKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoc2VsZWN0aXZlSWQpID0+XG4gICAgICAgIHRoaXMubXVsdGlDYXJ0RmFjYWRlLmdldEVudHJ5KHNlbGVjdGl2ZUlkLCBwcm9kdWN0Q29kZSlcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFNlbGVjdGl2ZUNhcnRJZCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLm11bHRpQ2FydEZhY2FkZS5nZXRDYXJ0SWRCeVR5cGUoQ2FydFR5cGUuU0VMRUNUSVZFKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2VsZWN0aXZlSWRXaXRoVXNlcklkKCk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZWxlY3RpdmVDYXJ0SWQoKS5waXBlKFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHRoaXMudXNlcklkU2VydmljZS5nZXRVc2VySWQoKSksXG4gICAgICB0YWtlKDEpXG4gICAgKTtcbiAgfVxufVxuIl19