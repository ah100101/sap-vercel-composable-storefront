/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { select } from '@ngrx/store';
import { CartActions, getCartIdByUserId, MultiCartSelectors, } from '@spartacus/cart/base/core';
import { CartType } from '@spartacus/cart/base/root';
import { isNotUndefined, normalizeHttpError, SiteContextActions, } from '@spartacus/core';
import { EMPTY, from } from 'rxjs';
import { catchError, concatMap, filter, map, switchMap, withLatestFrom, } from 'rxjs/operators';
import { WishListActions } from '../actions';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "@spartacus/cart/base/core";
import * as i3 from "@spartacus/core";
import * as i4 from "@ngrx/store";
export class WishListEffects {
    constructor(actions$, cartConnector, userIdService, store) {
        this.actions$ = actions$;
        this.cartConnector = cartConnector;
        this.userIdService = userIdService;
        this.store = store;
        this.createWishList$ = createEffect(() => this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST), map((action) => action.payload), switchMap((payload) => {
            return this.cartConnector.create(payload.userId).pipe(switchMap((cart) => {
                return this.cartConnector
                    .save(payload.userId, cart.code ?? '', payload.name, payload.description)
                    .pipe(switchMap((savedCart) => [
                    new WishListActions.CreateWishListSuccess({
                        cart: savedCart,
                        cartId: getCartIdByUserId(savedCart, payload.userId),
                    }),
                ]), catchError((error) => from([
                    new WishListActions.CreateWishListFail({
                        cartId: cart.code ?? '',
                        error: normalizeHttpError(error),
                    }),
                ])));
            }));
        })));
        this.loadWishList$ = createEffect(() => this.actions$.pipe(ofType(WishListActions.LOAD_WISH_LIST), map((action) => action.payload), concatMap((payload) => {
            const { userId, cartId } = payload;
            return this.cartConnector.loadAll(userId).pipe(switchMap((carts) => {
                const wishListName = cartId;
                const wishList = carts.find((cart) => cart.name === wishListName);
                const actions = [];
                actions.push(wishList
                    ? new WishListActions.LoadWishListSuccess({
                        cart: wishList,
                        cartId: getCartIdByUserId(wishList, userId),
                    })
                    : new WishListActions.CreateWishList({
                        userId,
                        name: wishListName,
                    }));
                // remove temp wishlist, which id is whishlist name
                actions.push(new CartActions.RemoveCart({ cartId: wishListName }));
                return actions;
            }), catchError((error) => from([
                new WishListActions.LoadWishListFail({
                    cartId: cartId,
                    error: normalizeHttpError(error),
                }),
            ])));
        })));
        this.resetWishList$ = createEffect(() => this.actions$.pipe(ofType(SiteContextActions.LANGUAGE_CHANGE, SiteContextActions.CURRENCY_CHANGE), withLatestFrom(this.userIdService.getUserId(), this.store.pipe(filter((store) => !!store.cart), select(MultiCartSelectors.getCartIdByTypeFactory(CartType.WISH_LIST)))), switchMap(([, userId, wishListId]) => {
            if (Boolean(wishListId)) {
                return this.cartConnector.load(userId, wishListId).pipe(switchMap((wishList) => [
                    new WishListActions.LoadWishListSuccess({
                        cart: wishList ?? {},
                        cartId: getCartIdByUserId(wishList, userId),
                    }),
                ]), catchError((error) => from([
                    new WishListActions.LoadWishListFail({
                        cartId: wishListId,
                        error: normalizeHttpError(error),
                    }),
                ])));
            }
            return EMPTY;
        })));
        this.setWishListId$ = createEffect(() => this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST_SUCCESS, WishListActions.LOAD_WISH_LIST_SUCCESS), map((action) => {
            switch (action.type) {
                case WishListActions.CREATE_WISH_LIST_SUCCESS:
                case WishListActions.LOAD_WISH_LIST_SUCCESS: {
                    return new CartActions.SetCartTypeIndex({
                        cartType: CartType.WISH_LIST,
                        cartId: action.meta
                            .entityId,
                    });
                }
            }
        }), filter(isNotUndefined)));
        this.setWishListData$ = createEffect(() => this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST_SUCCESS, WishListActions.LOAD_WISH_LIST_SUCCESS), map((action) => {
            switch (action.type) {
                case WishListActions.CREATE_WISH_LIST_SUCCESS:
                case WishListActions.LOAD_WISH_LIST_SUCCESS: {
                    return new CartActions.SetCartData({
                        cart: action.payload.cart,
                        cartId: action.payload.cartId,
                    });
                }
            }
        }), filter(isNotUndefined)));
    }
}
WishListEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: WishListEffects, deps: [{ token: i1.Actions }, { token: i2.CartConnector }, { token: i3.UserIdService }, { token: i4.Store }], target: i0.ɵɵFactoryTarget.Injectable });
WishListEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: WishListEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: WishListEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.CartConnector }, { type: i3.UserIdService }, { type: i4.Store }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lzaC1saXN0LmVmZmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9jYXJ0L3dpc2gtbGlzdC9jb3JlL3N0b3JlL2VmZmVjdHMvd2lzaC1saXN0LmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQVcsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQVUsTUFBTSxFQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BELE9BQU8sRUFDTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLGtCQUFrQixHQUVuQixNQUFNLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNyRCxPQUFPLEVBQ0wsY0FBYyxFQUNkLGtCQUFrQixFQUNsQixrQkFBa0IsR0FHbkIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQ0wsVUFBVSxFQUNWLFNBQVMsRUFDVCxNQUFNLEVBQ04sR0FBRyxFQUNILFNBQVMsRUFDVCxjQUFjLEdBQ2YsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDOzs7Ozs7QUFHN0MsTUFBTSxPQUFPLGVBQWU7SUFxSzFCLFlBQ1UsUUFBaUIsRUFDakIsYUFBNEIsRUFDNUIsYUFBNEIsRUFDNUIsS0FBZ0M7UUFIaEMsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixVQUFLLEdBQUwsS0FBSyxDQUEyQjtRQXhLMUMsb0JBQWUsR0FFWCxZ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Z0JBQ25CLEtBQUssZUFBZSxDQUFDLHdCQUF3QixDQUFDO2dCQUM5QyxLQUFLLGVBQWUsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO29CQUMzQyxPQUFPLElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQzt3QkFDakMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSTt3QkFDekIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTTtxQkFDOUIsQ0FBQyxDQUFDO2lCQUNKO2FBQ0Y7UUFDSCxDQUFDLENBQUMsRUFDRixNQUFNLENBQUMsY0FBYyxDQUFDLENBQ3ZCLENBQ0YsQ0FBQztJQU9DLENBQUM7OzRHQTFLTyxlQUFlO2dIQUFmLGVBQWU7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGlvbnMsIGNyZWF0ZUVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XG5pbXBvcnQgeyBBY3Rpb24sIHNlbGVjdCwgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQge1xuICBDYXJ0QWN0aW9ucyxcbiAgQ2FydENvbm5lY3RvcixcbiAgZ2V0Q2FydElkQnlVc2VySWQsXG4gIE11bHRpQ2FydFNlbGVjdG9ycyxcbiAgU3RhdGVXaXRoTXVsdGlDYXJ0LFxufSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9jb3JlJztcbmltcG9ydCB7IENhcnRUeXBlIH0gZnJvbSAnQHNwYXJ0YWN1cy9jYXJ0L2Jhc2Uvcm9vdCc7XG5pbXBvcnQge1xuICBpc05vdFVuZGVmaW5lZCxcbiAgbm9ybWFsaXplSHR0cEVycm9yLFxuICBTaXRlQ29udGV4dEFjdGlvbnMsXG4gIFN0YXRlVXRpbHMsXG4gIFVzZXJJZFNlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBFTVBUWSwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY2F0Y2hFcnJvcixcbiAgY29uY2F0TWFwLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgc3dpdGNoTWFwLFxuICB3aXRoTGF0ZXN0RnJvbSxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgV2lzaExpc3RBY3Rpb25zIH0gZnJvbSAnLi4vYWN0aW9ucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXaXNoTGlzdEVmZmVjdHMge1xuICBjcmVhdGVXaXNoTGlzdCQ6IE9ic2VydmFibGU8XG4gICAgV2lzaExpc3RBY3Rpb25zLkNyZWF0ZVdpc2hMaXN0U3VjY2VzcyB8IFdpc2hMaXN0QWN0aW9ucy5DcmVhdGVXaXNoTGlzdEZhaWxcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVCksXG4gICAgICBtYXAoKGFjdGlvbjogV2lzaExpc3RBY3Rpb25zLkNyZWF0ZVdpc2hMaXN0KSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgICBzd2l0Y2hNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FydENvbm5lY3Rvci5jcmVhdGUocGF5bG9hZC51c2VySWQpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChjYXJ0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yXG4gICAgICAgICAgICAgIC5zYXZlKFxuICAgICAgICAgICAgICAgIHBheWxvYWQudXNlcklkLFxuICAgICAgICAgICAgICAgIGNhcnQuY29kZSA/PyAnJyxcbiAgICAgICAgICAgICAgICBwYXlsb2FkLm5hbWUsXG4gICAgICAgICAgICAgICAgcGF5bG9hZC5kZXNjcmlwdGlvblxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoc2F2ZWRDYXJ0KSA9PiBbXG4gICAgICAgICAgICAgICAgICBuZXcgV2lzaExpc3RBY3Rpb25zLkNyZWF0ZVdpc2hMaXN0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICAgIGNhcnQ6IHNhdmVkQ2FydCxcbiAgICAgICAgICAgICAgICAgICAgY2FydElkOiBnZXRDYXJ0SWRCeVVzZXJJZChzYXZlZENhcnQsIHBheWxvYWQudXNlcklkKSxcbiAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgICAgICAgIG5ldyBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RGYWlsKHtcbiAgICAgICAgICAgICAgICAgICAgICBjYXJ0SWQ6IGNhcnQuY29kZSA/PyAnJyxcbiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKSxcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgbG9hZFdpc2hMaXN0JDogT2JzZXJ2YWJsZTxcbiAgICB8IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RTdWNjZXNzXG4gICAgfCBDYXJ0QWN0aW9ucy5SZW1vdmVDYXJ0XG4gICAgfCBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RcbiAgICB8IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RGYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoV2lzaExpc3RBY3Rpb25zLkxPQURfV0lTSF9MSVNUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBXaXNoTGlzdEFjdGlvbnMuTG9hZFdpc2hMaXN0KSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgICBjb25jYXRNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgY29uc3QgeyB1c2VySWQsIGNhcnRJZCB9ID0gcGF5bG9hZDtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FydENvbm5lY3Rvci5sb2FkQWxsKHVzZXJJZCkucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKGNhcnRzKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB3aXNoTGlzdE5hbWUgPSBjYXJ0SWQ7XG4gICAgICAgICAgICBjb25zdCB3aXNoTGlzdCA9IGNhcnRzLmZpbmQoKGNhcnQpID0+IGNhcnQubmFtZSA9PT0gd2lzaExpc3ROYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChcbiAgICAgICAgICAgICAgd2lzaExpc3RcbiAgICAgICAgICAgICAgICA/IG5ldyBXaXNoTGlzdEFjdGlvbnMuTG9hZFdpc2hMaXN0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICAgIGNhcnQ6IHdpc2hMaXN0LFxuICAgICAgICAgICAgICAgICAgICBjYXJ0SWQ6IGdldENhcnRJZEJ5VXNlcklkKHdpc2hMaXN0LCB1c2VySWQpLFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICA6IG5ldyBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3Qoe1xuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHdpc2hMaXN0TmFtZSxcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgLy8gcmVtb3ZlIHRlbXAgd2lzaGxpc3QsIHdoaWNoIGlkIGlzIHdoaXNobGlzdCBuYW1lXG4gICAgICAgICAgICBhY3Rpb25zLnB1c2gobmV3IENhcnRBY3Rpb25zLlJlbW92ZUNhcnQoeyBjYXJ0SWQ6IHdpc2hMaXN0TmFtZSB9KSk7XG4gICAgICAgICAgICByZXR1cm4gYWN0aW9ucztcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgIGZyb20oW1xuICAgICAgICAgICAgICBuZXcgV2lzaExpc3RBY3Rpb25zLkxvYWRXaXNoTGlzdEZhaWwoe1xuICAgICAgICAgICAgICAgIGNhcnRJZDogY2FydElkLFxuICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0pXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgcmVzZXRXaXNoTGlzdCQ6IE9ic2VydmFibGU8XG4gICAgV2lzaExpc3RBY3Rpb25zLkxvYWRXaXNoTGlzdFN1Y2Nlc3MgfCBXaXNoTGlzdEFjdGlvbnMuTG9hZFdpc2hMaXN0RmFpbFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKFxuICAgICAgICBTaXRlQ29udGV4dEFjdGlvbnMuTEFOR1VBR0VfQ0hBTkdFLFxuICAgICAgICBTaXRlQ29udGV4dEFjdGlvbnMuQ1VSUkVOQ1lfQ0hBTkdFXG4gICAgICApLFxuICAgICAgd2l0aExhdGVzdEZyb20oXG4gICAgICAgIHRoaXMudXNlcklkU2VydmljZS5nZXRVc2VySWQoKSxcbiAgICAgICAgdGhpcy5zdG9yZS5waXBlKFxuICAgICAgICAgIGZpbHRlcigoc3RvcmUpID0+ICEhc3RvcmUuY2FydCksXG4gICAgICAgICAgc2VsZWN0KE11bHRpQ2FydFNlbGVjdG9ycy5nZXRDYXJ0SWRCeVR5cGVGYWN0b3J5KENhcnRUeXBlLldJU0hfTElTVCkpXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICBzd2l0Y2hNYXAoKFssIHVzZXJJZCwgd2lzaExpc3RJZF0pID0+IHtcbiAgICAgICAgaWYgKEJvb2xlYW4od2lzaExpc3RJZCkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yLmxvYWQodXNlcklkLCB3aXNoTGlzdElkKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCh3aXNoTGlzdCkgPT4gW1xuICAgICAgICAgICAgICBuZXcgV2lzaExpc3RBY3Rpb25zLkxvYWRXaXNoTGlzdFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgIGNhcnQ6IHdpc2hMaXN0ID8/IHt9LFxuICAgICAgICAgICAgICAgIGNhcnRJZDogZ2V0Q2FydElkQnlVc2VySWQod2lzaExpc3QsIHVzZXJJZCksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgICAgbmV3IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RGYWlsKHtcbiAgICAgICAgICAgICAgICAgIGNhcnRJZDogd2lzaExpc3RJZCxcbiAgICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgc2V0V2lzaExpc3RJZCQ6IE9ic2VydmFibGU8Q2FydEFjdGlvbnMuU2V0Q2FydFR5cGVJbmRleD4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoXG4gICAgICAgIFdpc2hMaXN0QWN0aW9ucy5DUkVBVEVfV0lTSF9MSVNUX1NVQ0NFU1MsXG4gICAgICAgIFdpc2hMaXN0QWN0aW9ucy5MT0FEX1dJU0hfTElTVF9TVUNDRVNTXG4gICAgICApLFxuICAgICAgbWFwKChhY3Rpb246IEFjdGlvbikgPT4ge1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgICAgY2FzZSBXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVF9TVUNDRVNTOlxuICAgICAgICAgIGNhc2UgV2lzaExpc3RBY3Rpb25zLkxPQURfV0lTSF9MSVNUX1NVQ0NFU1M6IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ2FydEFjdGlvbnMuU2V0Q2FydFR5cGVJbmRleCh7XG4gICAgICAgICAgICAgIGNhcnRUeXBlOiBDYXJ0VHlwZS5XSVNIX0xJU1QsXG4gICAgICAgICAgICAgIGNhcnRJZDogKGFjdGlvbiBhcyBTdGF0ZVV0aWxzLkVudGl0eVN1Y2Nlc3NBY3Rpb24pLm1ldGFcbiAgICAgICAgICAgICAgICAuZW50aXR5SWQgYXMgc3RyaW5nLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIGZpbHRlcihpc05vdFVuZGVmaW5lZClcbiAgICApXG4gICk7XG5cbiAgc2V0V2lzaExpc3REYXRhJDogT2JzZXJ2YWJsZTxDYXJ0QWN0aW9ucy5TZXRDYXJ0RGF0YT4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoXG4gICAgICAgIFdpc2hMaXN0QWN0aW9ucy5DUkVBVEVfV0lTSF9MSVNUX1NVQ0NFU1MsXG4gICAgICAgIFdpc2hMaXN0QWN0aW9ucy5MT0FEX1dJU0hfTElTVF9TVUNDRVNTXG4gICAgICApLFxuICAgICAgbWFwKChhY3Rpb246IFN0YXRlVXRpbHMuRW50aXR5U3VjY2Vzc0FjdGlvbikgPT4ge1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgICAgY2FzZSBXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVF9TVUNDRVNTOlxuICAgICAgICAgIGNhc2UgV2lzaExpc3RBY3Rpb25zLkxPQURfV0lTSF9MSVNUX1NVQ0NFU1M6IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ2FydEFjdGlvbnMuU2V0Q2FydERhdGEoe1xuICAgICAgICAgICAgICBjYXJ0OiBhY3Rpb24ucGF5bG9hZC5jYXJ0LFxuICAgICAgICAgICAgICBjYXJ0SWQ6IGFjdGlvbi5wYXlsb2FkLmNhcnRJZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoaXNOb3RVbmRlZmluZWQpXG4gICAgKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWN0aW9ucyQ6IEFjdGlvbnMsXG4gICAgcHJpdmF0ZSBjYXJ0Q29ubmVjdG9yOiBDYXJ0Q29ubmVjdG9yLFxuICAgIHByaXZhdGUgdXNlcklkU2VydmljZTogVXNlcklkU2VydmljZSxcbiAgICBwcml2YXRlIHN0b3JlOiBTdG9yZTxTdGF0ZVdpdGhNdWx0aUNhcnQ+XG4gICkge31cbn1cbiJdfQ==