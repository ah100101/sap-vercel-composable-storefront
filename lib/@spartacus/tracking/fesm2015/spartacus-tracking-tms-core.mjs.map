{"version":3,"file":"spartacus-tracking-tms-core.mjs","sources":["../../../feature-libs/tracking/tms/core/config/tms-config.ts","../../../feature-libs/tracking/tms/core/services/tms.service.ts","../../../feature-libs/tracking/tms/core/base-tms.module.ts","../../../feature-libs/tracking/tms/core/config/index.ts","../../../feature-libs/tracking/tms/core/model/index.ts","../../../feature-libs/tracking/tms/core/services/index.ts","../../../feature-libs/tracking/tms/core/public_api.ts","../../../feature-libs/tracking/tms/core/spartacus-tracking-tms-core.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { AbstractType, Injectable, Type } from '@angular/core';\nimport { Config, CxEvent } from '@spartacus/core';\nimport { TmsCollector } from '../model/tms.model';\n\n/**\n * Collector configuration\n */\nexport interface TmsCollectorConfig {\n  /** Should be enabled in development mode only */\n  debug?: boolean;\n  /**\n   * The name for the data layer object.\n   */\n  dataLayerProperty?: string;\n  /**\n   * Events to send to the configured TMS.\n   */\n  events?: AbstractType<CxEvent>[];\n  /**\n   * The collector service implementation.\n   */\n  collector?: Type<TmsCollector>;\n}\n\nexport interface TmsCollectors {\n  [tms: string]: TmsCollectorConfig | undefined;\n}\n\n/**\n * TMS configuration\n */\n@Injectable({\n  providedIn: 'root',\n  useExisting: Config,\n})\nexport abstract class TmsConfig {\n  /**\n   * Tag manager config\n   */\n  tagManager?: TmsCollectors;\n}\n\ndeclare module '@spartacus/core' {\n  interface Config extends TmsConfig {}\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Injectable, Injector, isDevMode, OnDestroy } from '@angular/core';\nimport { CxEvent, EventService, WindowRef } from '@spartacus/core';\nimport { merge, Observable, Subscription } from 'rxjs';\nimport { TmsConfig } from '../config/tms-config';\nimport { TmsCollector } from '../model/tms.model';\n\n/**\n * This service interacts with the configured data layer object by pushing the Spartacus events to it.\n */\n@Injectable({ providedIn: 'root' })\nexport class TmsService implements OnDestroy {\n  /**\n   * Stores subscriptions to events.\n   */\n  protected subscription = new Subscription();\n\n  constructor(\n    protected eventsService: EventService,\n    protected windowRef: WindowRef,\n    protected tmsConfig: TmsConfig,\n    protected injector: Injector\n  ) {}\n\n  /**\n   * Called only once to start collecting and dispatching events\n   */\n  collect(): void {\n    if (!this.windowRef.isBrowser()) {\n      return;\n    }\n\n    for (const tmsCollectorConfig in this.tmsConfig.tagManager) {\n      if (!this.tmsConfig.tagManager?.hasOwnProperty(tmsCollectorConfig)) {\n        continue;\n      }\n\n      const collectorConfig =\n        this.tmsConfig.tagManager[tmsCollectorConfig] ?? {};\n\n      if (!collectorConfig.collector) {\n        if (isDevMode()) {\n          console.warn(\n            `Skipping the '${tmsCollectorConfig}', as the collector is not defined.`\n          );\n        }\n        continue;\n      }\n\n      const events =\n        collectorConfig.events?.map((event) => this.eventsService.get(event)) ||\n        [];\n      const collector = this.injector.get<TmsCollector>(\n        collectorConfig.collector\n      );\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      collector.init(collectorConfig, this.windowRef.nativeWindow!);\n\n      this.subscription.add(\n        this.mapEvents(events).subscribe((event) => {\n          if (collectorConfig.debug) {\n            console.log(\n              `ðŸŽ¤ Pushing the following event to ${tmsCollectorConfig}: `,\n              event\n            );\n          }\n\n          event = collector.map?.(event) ?? event;\n          collector.pushEvent(\n            collectorConfig,\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n            this.windowRef.nativeWindow!,\n            event\n          );\n        })\n      );\n    }\n  }\n\n  /**\n   * Maps the given events to an appropriate type that fits the specified TMS' structure.\n   *\n   * @param events - the events to map\n   * @param collector - a name of the collector for which the events should be mapped\n   */\n  protected mapEvents<T extends CxEvent>(\n    events: Observable<T>[]\n  ): Observable<T> {\n    return merge(...events);\n  }\n\n  /**\n   * Angular's callback\n   */\n  ngOnDestroy(): void {\n    this.subscription.unsubscribe();\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { APP_INITIALIZER, ModuleWithProviders, NgModule } from '@angular/core';\nimport { TmsService } from './services/tms.service';\n\n/**\n * The factory that conditionally (based on the configuration) starts collecting events\n */\nexport function tmsFactory(service: TmsService): () => void {\n  const result = () => service.collect();\n  return result;\n}\n\n@NgModule({})\nexport class BaseTmsModule {\n  static forRoot(): ModuleWithProviders<BaseTmsModule> {\n    return {\n      ngModule: BaseTmsModule,\n      providers: [\n        {\n          provide: APP_INITIALIZER,\n          useFactory: tmsFactory,\n          deps: [TmsService],\n          multi: true,\n        },\n      ],\n    };\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './tms-config';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './tms.model';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './tms.service';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './base-tms.module';\nexport * from './config/index';\nexport * from './model/index';\nexport * from './services/index';\n\n/** AUGMENTABLE_TYPES_START */\nexport { TmsCollectors } from './config/tms-config';\n/** AUGMENTABLE_TYPES_END */\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":["i2.TmsConfig"],"mappings":"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"}