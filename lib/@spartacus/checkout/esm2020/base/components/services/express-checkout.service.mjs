/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { combineLatest, of } from 'rxjs';
import { catchError, debounceTime, distinctUntilChanged, filter, map, switchMap, take, tap, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "@spartacus/checkout/base/root";
import * as i3 from "../services/checkout-config.service";
export class ExpressCheckoutService {
    constructor(userAddressService, userPaymentService, checkoutDeliveryAddressFacade, checkoutPaymentFacade, checkoutConfigService, checkoutDeliveryModesFacade) {
        this.userAddressService = userAddressService;
        this.userPaymentService = userPaymentService;
        this.checkoutDeliveryAddressFacade = checkoutDeliveryAddressFacade;
        this.checkoutPaymentFacade = checkoutPaymentFacade;
        this.checkoutConfigService = checkoutConfigService;
        this.checkoutDeliveryModesFacade = checkoutDeliveryModesFacade;
        this.setDeliveryAddress();
        this.setDeliveryMode();
        this.setPaymentMethod();
    }
    setDeliveryAddress() {
        this.deliveryAddressSet$ = combineLatest([
            this.userAddressService.getAddresses(),
            this.userAddressService.getAddressesLoadedSuccess(),
        ]).pipe(debounceTime(0), tap(([, addressesLoadedSuccess]) => {
            if (!addressesLoadedSuccess) {
                this.userAddressService.loadAddresses();
            }
        }), filter(([, addressesLoadedSuccess]) => addressesLoadedSuccess), take(1), switchMap(([addresses]) => {
            const defaultAddress = addresses.find((address) => address.defaultAddress) || addresses[0];
            if (defaultAddress && Object.keys(defaultAddress).length) {
                return this.checkoutDeliveryAddressFacade
                    .setDeliveryAddress(defaultAddress)
                    .pipe(switchMap(() => this.checkoutDeliveryAddressFacade.getDeliveryAddressState()), filter((state) => !state.error && !state.loading), map((state) => state.data), map((data) => !!(data && Object.keys(data).length)), catchError(() => of(false)));
            }
            return of(false);
        }), distinctUntilChanged());
    }
    setDeliveryMode() {
        this.deliveryModeSet$ = combineLatest([
            this.deliveryAddressSet$,
            this.checkoutDeliveryModesFacade.getSupportedDeliveryModesState(),
        ]).pipe(debounceTime(0), switchMap(([addressSet, supportedDeliveryModesState]) => {
            if (!addressSet) {
                return of(false);
            }
            return of([supportedDeliveryModesState]).pipe(filter(([supportedDeliveryModesStateObject]) => !supportedDeliveryModesStateObject.loading &&
                !!supportedDeliveryModesStateObject.data?.length), switchMap(([deliveryModesState]) => {
                if (!deliveryModesState.data) {
                    return of(false);
                }
                const preferredDeliveryMode = this.checkoutConfigService.getPreferredDeliveryMode(deliveryModesState.data);
                return of([preferredDeliveryMode]).pipe(switchMap(([deliveryMode]) => {
                    if (!deliveryMode) {
                        return of(false);
                    }
                    return this.checkoutDeliveryModesFacade
                        .setDeliveryMode(deliveryMode)
                        .pipe(switchMap(() => this.checkoutDeliveryModesFacade.getSelectedDeliveryModeState()), filter((state) => !state.error && !state.loading), map((state) => state.data), map((data) => !!(data && Object.keys(data).length)), catchError(() => of(false)));
                }));
            }));
        }), distinctUntilChanged());
    }
    setPaymentMethod() {
        this.paymentMethodSet$ = combineLatest([
            this.deliveryModeSet$,
            this.userPaymentService.getPaymentMethods(),
            this.userPaymentService.getPaymentMethodsLoadedSuccess(),
        ]).pipe(debounceTime(0), tap(([, , paymentMethodsLoadedSuccess]) => {
            if (!paymentMethodsLoadedSuccess) {
                this.userPaymentService.loadPaymentMethods();
            }
        }), filter(([, , success]) => success), switchMap(([deliveryModeSet, payments]) => {
            if (!deliveryModeSet) {
                return of(false);
            }
            const defaultPayment = payments.find((address) => address.defaultPayment) || payments[0];
            if (!defaultPayment || Object.keys(defaultPayment).length === 0) {
                return of(false);
            }
            return this.checkoutPaymentFacade
                .setPaymentDetails(defaultPayment)
                .pipe(switchMap(() => this.checkoutPaymentFacade.getPaymentDetailsState()), filter((state) => !state.error && !state.loading), map((state) => state.data), map((data) => !!(data && Object.keys(data).length)), catchError(() => of(false)));
        }), distinctUntilChanged());
    }
    trySetDefaultCheckoutDetails() {
        return this.paymentMethodSet$.pipe(map((paymentMethodSet) => !!paymentMethodSet));
    }
}
ExpressCheckoutService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: ExpressCheckoutService, deps: [{ token: i1.UserAddressService }, { token: i1.UserPaymentService }, { token: i2.CheckoutDeliveryAddressFacade }, { token: i2.CheckoutPaymentFacade }, { token: i3.CheckoutConfigService }, { token: i2.CheckoutDeliveryModesFacade }], target: i0.ɵɵFactoryTarget.Injectable });
ExpressCheckoutService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: ExpressCheckoutService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.4", ngImport: i0, type: ExpressCheckoutService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.UserAddressService }, { type: i1.UserPaymentService }, { type: i2.CheckoutDeliveryAddressFacade }, { type: i2.CheckoutPaymentFacade }, { type: i3.CheckoutConfigService }, { type: i2.CheckoutDeliveryModesFacade }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy1jaGVja291dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL2NoZWNrb3V0L2Jhc2UvY29tcG9uZW50cy9zZXJ2aWNlcy9leHByZXNzLWNoZWNrb3V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFPM0MsT0FBTyxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUNMLFVBQVUsRUFDVixZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixHQUFHLEVBQ0gsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEdBQ0osTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7QUFNeEIsTUFBTSxPQUFPLHNCQUFzQjtJQUtqQyxZQUNZLGtCQUFzQyxFQUN0QyxrQkFBc0MsRUFDdEMsNkJBQTRELEVBQzVELHFCQUE0QyxFQUM1QyxxQkFBNEMsRUFDNUMsMkJBQXdEO1FBTHhELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxrQ0FBNkIsR0FBN0IsNkJBQTZCLENBQStCO1FBQzVELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBRWxFLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRVMsa0JBQWtCO1FBQzFCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxhQUFhLENBQUM7WUFDdkMsSUFBSSxDQUFDLGtCQUFrQixD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QUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQzFCLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDbkQsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUM1QixDQUFDO1FBQ04sQ0FBQyxDQUFDLEVBQ0Ysb0JBQW9CLEVBQUUsQ0FDdkIsQ0FBQztJQUNKLENBQUM7SUFFTSw0QkFBNEI7UUFDakMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUNoQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQzlDLENBQUM7SUFDSixDQUFDOzttSEFqSlUsc0JBQXNCO3VIQUF0QixzQkFBc0IsY0FGckIsTUFBTTsyRkFFUCxzQkFBc0I7a0JBSGxDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ2hlY2tvdXREZWxpdmVyeUFkZHJlc3NGYWNhZGUsXG4gIENoZWNrb3V0RGVsaXZlcnlNb2Rlc0ZhY2FkZSxcbiAgQ2hlY2tvdXRQYXltZW50RmFjYWRlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NoZWNrb3V0L2Jhc2Uvcm9vdCc7XG5pbXBvcnQgeyBVc2VyQWRkcmVzc1NlcnZpY2UsIFVzZXJQYXltZW50U2VydmljZSB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY2F0Y2hFcnJvcixcbiAgZGVib3VuY2VUaW1lLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZSxcbiAgdGFwLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDaGVja291dENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jaGVja291dC1jb25maWcuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBFeHByZXNzQ2hlY2tvdXRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBkZWxpdmVyeUFkZHJlc3NTZXQkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBwcml2YXRlIGRlbGl2ZXJ5TW9kZVNldCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHByaXZhdGUgcGF5bWVudE1ldGhvZFNldCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHVzZXJBZGRyZXNzU2VydmljZTogVXNlckFkZHJlc3NTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB1c2VyUGF5bWVudFNlcnZpY2U6IFVzZXJQYXltZW50U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgY2hlY2tvdXREZWxpdmVyeUFkZHJlc3NGYWNhZGU6IENoZWNrb3V0RGVsaXZlcnlBZGRyZXNzRmFjYWRlLFxuICAgIHByb3RlY3RlZCBjaGVja291dFBheW1lbnRGYWNhZGU6IENoZWNrb3V0UGF5bWVudEZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgY2hlY2tvdXRDb25maWdTZXJ2aWNlOiBDaGVja291dENvbmZpZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNoZWNrb3V0RGVsaXZlcnlNb2Rlc0ZhY2FkZTogQ2hlY2tvdXREZWxpdmVyeU1vZGVzRmFjYWRlXG4gICkge1xuICAgIHRoaXMuc2V0RGVsaXZlcnlBZGRyZXNzKCk7XG4gICAgdGhpcy5zZXREZWxpdmVyeU1vZGUoKTtcbiAgICB0aGlzLnNldFBheW1lbnRNZXRob2QoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXREZWxpdmVyeUFkZHJlc3MoKTogdm9pZCB7XG4gICAgdGhpcy5kZWxpdmVyeUFkZHJlc3NTZXQkID0gY29tYmluZUxhdGVzdChbXG4gICAgICB0aGlzLnVzZXJBZGRyZXNzU2VydmljZS5nZXRBZGRyZXNzZXMoKSxcbiAgICAgIHRoaXMudXNlckFkZHJlc3NTZXJ2aWNlLmdldEFkZHJlc3Nlc0xvYWRlZFN1Y2Nlc3MoKSxcbiAgICBdKS5waXBlKFxuICAgICAgZGVib3VuY2VUaW1lKDApLFxuICAgICAgdGFwKChbLCBhZGRyZXNzZXNMb2FkZWRTdWNjZXNzXSkgPT4ge1xuICAgICAgICBpZiAoIWFkZHJlc3Nlc0xvYWRlZFN1Y2Nlc3MpIHtcbiAgICAgICAgICB0aGlzLnVzZXJBZGRyZXNzU2VydmljZS5sb2FkQWRkcmVzc2VzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZmlsdGVyKChbLCBhZGRyZXNzZXNMb2FkZWRTdWNjZXNzXSkgPT4gYWRkcmVzc2VzTG9hZGVkU3VjY2VzcyksXG4gICAgICB0YWtlKDEpLFxuICAgICAgc3dpdGNoTWFwKChbYWRkcmVzc2VzXSkgPT4ge1xuICAgICAgICBjb25zdCBkZWZhdWx0QWRkcmVzcyA9XG4gICAgICAgICAgYWRkcmVzc2VzLmZpbmQoKGFkZHJlc3MpID0+IGFkZHJlc3MuZGVmYXVsdEFkZHJlc3MpIHx8IGFkZHJlc3Nlc1swXTtcbiAgICAgICAgaWYgKGRlZmF1bHRBZGRyZXNzICYmIE9iamVjdC5rZXlzKGRlZmF1bHRBZGRyZXNzKS5sZW5ndGgpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja291dERlbGl2ZXJ5QWRkcmVzc0ZhY2FkZVxuICAgICAgICAgICAgLnNldERlbGl2ZXJ5QWRkcmVzcyhkZWZhdWx0QWRkcmVzcylcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrb3V0RGVsaXZlcnlBZGRyZXNzRmFjYWRlLmdldERlbGl2ZXJ5QWRkcmVzc1N0YXRlKClcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgZmlsdGVyKChzdGF0ZSkgPT4gIXN0YXRlLmVycm9yICYmICFzdGF0ZS5sb2FkaW5nKSxcbiAgICAgICAgICAgICAgbWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YSksXG4gICAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4gISEoZGF0YSAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGgpKSxcbiAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihmYWxzZSkpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICB9KSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNldERlbGl2ZXJ5TW9kZSgpOiB2b2lkIHtcbiAgICB0aGlzLmRlbGl2ZXJ5TW9kZVNldCQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMuZGVsaXZlcnlBZGRyZXNzU2V0JCxcbiAgICAgIHRoaXMuY2hlY2tvdXREZWxpdmVyeU1vZGVzRmFjYWRlLmdldFN1cHBvcnRlZERlbGl2ZXJ5TW9kZXNTdGF0ZSgpLFxuICAgIF0pLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoMCksXG4gICAgICBzd2l0Y2hNYXAoKFthZGRyZXNzU2V0LCBzdXBwb3J0ZWREZWxpdmVyeU1vZGVzU3RhdGVdKSA9PiB7XG4gICAgICAgIGlmICghYWRkcmVzc1NldCkge1xuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9mKFtzdXBwb3J0ZWREZWxpdmVyeU1vZGVzU3RhdGVdKS5waXBlKFxuICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgIChbc3VwcG9ydGVkRGVsaXZlcnlNb2Rlc1N0YXRlT2JqZWN0XSkgPT5cbiAgICAgICAgICAgICAgIXN1cHBvcnRlZERlbGl2ZXJ5TW9kZXNTdGF0ZU9iamVjdC5sb2FkaW5nICYmXG4gICAgICAgICAgICAgICEhc3VwcG9ydGVkRGVsaXZlcnlNb2Rlc1N0YXRlT2JqZWN0LmRhdGE/Lmxlbmd0aFxuICAgICAgICAgICksXG4gICAgICAgICAgc3dpdGNoTWFwKChbZGVsaXZlcnlNb2Rlc1N0YXRlXSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFkZWxpdmVyeU1vZGVzU3RhdGUuZGF0YSkge1xuICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcHJlZmVycmVkRGVsaXZlcnlNb2RlID1cbiAgICAgICAgICAgICAgdGhpcy5jaGVja291dENvbmZpZ1NlcnZpY2UuZ2V0UHJlZmVycmVkRGVsaXZlcnlNb2RlKFxuICAgICAgICAgICAgICAgIGRlbGl2ZXJ5TW9kZXNTdGF0ZS5kYXRhXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gb2YoW3ByZWZlcnJlZERlbGl2ZXJ5TW9kZV0pLnBpcGUoXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgoW2RlbGl2ZXJ5TW9kZV0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWRlbGl2ZXJ5TW9kZSkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tvdXREZWxpdmVyeU1vZGVzRmFjYWRlXG4gICAgICAgICAgICAgICAgICAuc2V0RGVsaXZlcnlNb2RlKGRlbGl2ZXJ5TW9kZSlcbiAgICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrb3V0RGVsaXZlcnlNb2Rlc0ZhY2FkZS5nZXRTZWxlY3RlZERlbGl2ZXJ5TW9kZVN0YXRlKClcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChzdGF0ZSkgPT4gIXN0YXRlLmVycm9yICYmICFzdGF0ZS5sb2FkaW5nKSxcbiAgICAgICAgICAgICAgICAgICAgbWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YSksXG4gICAgICAgICAgICAgICAgICAgIG1hcCgoZGF0YSkgPT4gISEoZGF0YSAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGgpKSxcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihmYWxzZSkpXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRQYXltZW50TWV0aG9kKCk6IHZvaWQge1xuICAgIHRoaXMucGF5bWVudE1ldGhvZFNldCQgPSBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMuZGVsaXZlcnlNb2RlU2V0JCxcbiAgICAgIHRoaXMudXNlclBheW1lbnRTZXJ2aWNlLmdldFBheW1lbnRNZXRob2RzKCksXG4gICAgICB0aGlzLnVzZXJQYXltZW50U2VydmljZS5nZXRQYXltZW50TWV0aG9kc0xvYWRlZFN1Y2Nlc3MoKSxcbiAgICBdKS5waXBlKFxuICAgICAgZGVib3VuY2VUaW1lKDApLFxuICAgICAgdGFwKChbLCAsIHBheW1lbnRNZXRob2RzTG9hZGVkU3VjY2Vzc10pID0+IHtcbiAgICAgICAgaWYgKCFwYXltZW50TWV0aG9kc0xvYWRlZFN1Y2Nlc3MpIHtcbiAgICAgICAgICB0aGlzLnVzZXJQYXltZW50U2VydmljZS5sb2FkUGF5bWVudE1ldGhvZHMoKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoKFssICwgc3VjY2Vzc10pID0+IHN1Y2Nlc3MpLFxuICAgICAgc3dpdGNoTWFwKChbZGVsaXZlcnlNb2RlU2V0LCBwYXltZW50c10pID0+IHtcbiAgICAgICAgaWYgKCFkZWxpdmVyeU1vZGVTZXQpIHtcbiAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdFBheW1lbnQgPVxuICAgICAgICAgIHBheW1lbnRzLmZpbmQoKGFkZHJlc3MpID0+IGFkZHJlc3MuZGVmYXVsdFBheW1lbnQpIHx8IHBheW1lbnRzWzBdO1xuICAgICAgICBpZiAoIWRlZmF1bHRQYXltZW50IHx8IE9iamVjdC5rZXlzKGRlZmF1bHRQYXltZW50KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmNoZWNrb3V0UGF5bWVudEZhY2FkZVxuICAgICAgICAgIC5zZXRQYXltZW50RGV0YWlscyhkZWZhdWx0UGF5bWVudClcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgICAgICB0aGlzLmNoZWNrb3V0UGF5bWVudEZhY2FkZS5nZXRQYXltZW50RGV0YWlsc1N0YXRlKClcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBmaWx0ZXIoKHN0YXRlKSA9PiAhc3RhdGUuZXJyb3IgJiYgIXN0YXRlLmxvYWRpbmcpLFxuICAgICAgICAgICAgbWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YSksXG4gICAgICAgICAgICBtYXAoKGRhdGEpID0+ICEhKGRhdGEgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoKSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKGZhbHNlKSlcbiAgICAgICAgICApO1xuICAgICAgfSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyB0cnlTZXREZWZhdWx0Q2hlY2tvdXREZXRhaWxzKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnBheW1lbnRNZXRob2RTZXQkLnBpcGUoXG4gICAgICBtYXAoKHBheW1lbnRNZXRob2RTZXQpID0+ICEhcGF5bWVudE1ldGhvZFNldClcbiAgICApO1xuICB9XG59XG4iXX0=